#!/bin/sh
set -e

# Determine the architecture
if [ "${CONFIG_COMMAND##*.}" = "x86_64" ]; then
    ARCH="x86_64"
else
    ARCH="aarch64"
fi

# Set up environment variables for cosmocc
export CC="/ahgamut/superconfigure/cosmopolitan/cosmocc/bin/${ARCH}-unknown-cosmo-cc"
export CXX="/ahgamut/superconfigure/cosmopolitan/cosmocc/bin/${ARCH}-unknown-cosmo-c++"
export CFLAGS="-Os -I$COSMOS/include/ncurses -fno-strict-aliasing -Wno-unknown-pragmas -Wno-error=initializer-overrides -Wno-overlength-strings"
export CXXFLAGS="$CFLAGS"
export CPPFLAGS="-D_DEFAULT_SOURCE -D_XOPEN_SOURCE=600"
export LDFLAGS="-static"

# Create a temporary config.sub with Cosmopolitan OS support
TEMP_CONFIG_SUB=$(mktemp)
cat "$BASELOC"/o/cli/htop/htop-3.3.0/build-aux/config.sub > "$TEMP_CONFIG_SUB"
sed -i 's/-\*-\*)/&\n    cosmo*)\n      os=cosmo\n      ;;\n/' "$TEMP_CONFIG_SUB"

# Run configure with explicit settings
"$BASELOC"/o/cli/htop/htop-3.3.0/configure \
    --prefix="$COSMOS" \
    --host="${ARCH}-unknown-linux-gnu" \
    --enable-static \
    --disable-shared \
    --disable-unicode \
    --config-cache \
    --enable-openvz \
    --enable-vserver \
    --enable-ancient-vserver \
    --enable-hwloc \
    --enable-delayacct \
    --enable-capabilities \
    CONFIG_SUB="$TEMP_CONFIG_SUB"

# Clean up
rm -f "$TEMP_CONFIG_SUB"
